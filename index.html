// walcottinotv.js
// Single-file fullstack sports news + ads platform

const express = require("express");
const axios = require("axios");
const Parser = require("rss-parser");
const app = express();
const PORT = process.env.PORT || 3000;
const parser = new Parser();

// ==== CONFIG ==== //
const BRAND_NAME = "Walcottinotv";
const BRAND_MISSION = "To connect the world to the pulse of sports, uncover the latest stories, and empower local talents to shine globally, while offering high-quality, affordable sportswear.";

const SOCIAL_LINKS = {
  facebook: "https://www.facebook.com/share/1CSYTgmTX9/",
  instagram: "https://www.instagram.com/walcotttinotv?igsh=MW44Z2QwY2toN2YyNg==",
  twitter: "https://x.com/walcotttv2025?t=A--G6KfJcBGf2kz_PAnzlw&s=09",
};

const CONTACT = {
  phones: ["+2348137208793", "+2349045548253"],
  address: "B5, Legacy Estate, Kolapo Ishola GRA, Akobo Ibadan, Oyo State, Nigeria",
};

// ==== STATIC ADS ==== //
const ads = [
  { id: 1, image: "https://source.unsplash.com/600x150/?football", link: "https://example.com/footballgear" },
  { id: 2, image: "https://source.unsplash.com/600x150/?sports", link: "https://example.com/sportsoffers" }
];

// ==== RSS SOURCES ==== //
const RSS_FEEDS = {
  global: [
    "https://www.espn.com/espn/rss/news",
    "https://www.skysports.com/rss/12040"
  ],
  africa: [
    "https://www.kickoff.com/rss/news"
  ],
  nigeria: [
    "https://www.completesports.com/feed/"
  ]
};

// ==== CACHE ==== //
let newsCache = [];
let lastFetch = 0;
const CACHE_DURATION = 15 * 60 * 1000; // 15 mins

// ==== FUNCTION TO FETCH NEWS ==== //
async function fetchNews() {
  try {
    let allNews = [];
    for (const [category, urls] of Object.entries(RSS_FEEDS)) {
      for (const url of urls) {
        const feed = await parser.parseURL(url);
        feed.items.forEach(item => {
          allNews.push({
            title: item.title,
            link: item.link,
            date: item.pubDate,
            category
          });
        });
      }
    }
    // Shuffle and categorize percentages
    const globalNews = allNews.filter(n => n.category === "global").slice(0, Math.floor(allNews.length * 0.8));
    const africaNews = allNews.filter(n => n.category === "africa").slice(0, Math.floor(allNews.length * 0.1));
    const nigeriaNews = allNews.filter(n => n.category === "nigeria").slice(0, Math.floor(allNews.length * 0.1));

    newsCache = [...globalNews, ...africaNews, ...nigeriaNews].sort((a, b) => new Date(b.date) - new Date(a.date));
    lastFetch = Date.now();
  } catch (err) {
    console.error("Error fetching news:", err.message);
  }
}

// ==== MIDDLEWARE ==== //
app.use(express.json());

// ==== ROUTES ==== //
app.get("/", async (req, res) => {
  if (Date.now() - lastFetch > CACHE_DURATION) await fetchNews();

  const html = `
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>${BRAND_NAME}</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; background: #f4f9ff; color: #222; }
      header { background: #003366; color: #fff; padding: 20px; text-align: center; }
      nav a { margin: 0 10px; color: #fff; text-decoration: none; }
      section { padding: 20px; }
      h2 { color: #003366; }
      .news-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
      .ad { text-align: center; margin: 20px 0; }
      footer { background: #003366; color: white; text-align: center; padding: 10px; }
    </style>
  </head>
  <body>
    <header>
      <h1>${BRAND_NAME}</h1>
      <p>${BRAND_MISSION}</p>
      <nav>
        <a href="#">Home</a>
        <a href="#news">News</a>
        <a href="#contact">Contact</a>
      </nav>
    </header>

    <section id="ads">
      ${ads.map(ad => `<div class="ad"><a href="${ad.link}" target="_blank"><img src="${ad.image}" width="600" height="150" /></a></div>`).join("")}
    </section>

    <section id="news">
      <h2>Latest Sports News</h2>
      ${newsCache.map(n => `
        <div class="news-item">
          <a href="${n.link}" target="_blank">${n.title}</a> <br/>
          <small>${new Date(n.date).toLocaleString()}</small>
        </div>
      `).join("")}
    </section>

    <section id="contact">
      <h2>Contact Us</h2>
      <p><b>Phone:</b> ${CONTACT.phones.join(", ")}</p>
      <p><b>Address:</b> ${CONTACT.address}</p>
      <p>
        <a href="${SOCIAL_LINKS.facebook}" target="_blank">Facebook</a> |
        <a href="${SOCIAL_LINKS.instagram}" target="_blank">Instagram</a> |
        <a href="${SOCIAL_LINKS.twitter}" target="_blank">Twitter</a>
      </p>
    </section>

    <footer>
      &copy; ${new Date().getFullYear()} ${BRAND_NAME}. All rights reserved.
    </footer>
  </body>
  </html>
  `;
  res.send(html);
});

// ==== START SERVER ==== //
app.listen(PORT, async () => {
  console.log(`${BRAND_NAME} running on port ${PORT}`);
  await fetchNews();
});
